---
# Weather MCP-Only Server Cleanup Playbook
# 
# This playbook removes the exact weather MCP-only resources deployed by deploy-weather-mcp-only.yml
# Useful for:
# - Development iterations of pure MCP protocol
# - Testing different MCP configurations
# - Troubleshooting MCP protocol issues
# - Complete MCP-only environment reset
#
# Prerequisites:
# - Kubernetes cluster access
# - kubectl configured with appropriate permissions
# - Same kubeconfig used for original deployment
#
# Usage:
#   ansible-playbook cleanup-weather-mcp-only.yml
#   ansible-playbook cleanup-weather-mcp-only.yml --extra-vars "force_cleanup=true"
#
- name: Cleanup Weather MCP-Only Server Resources
  hosts: localhost
  gather_facts: false
  vars_files:
    - ../../../group_vars/all.yml
  vars:
    kubeconfig_path: "{{ playbook_dir }}/../../../kubeconfig"
    kubectl_cmd: "kubectl --kubeconfig={{ kubeconfig_path }}"
    ai_namespace: "ai-services"
    
    # MCP-only service configuration (must match deployment)
    service_name: "weather-mcp-only"
    
    # Cleanup confirmation (can be overridden with --extra-vars "force_cleanup=true")
    force_cleanup: false

  tasks:
    # Phase 0: Prerequisites and Confirmation
    - name: Check if kubeconfig exists
      stat:
        path: "{{ kubeconfig_path }}"
      register: kubeconfig_file

    - name: Fail if kubeconfig doesn't exist
      fail:
        msg: "Kubeconfig file not found at {{ kubeconfig_path }}"
      when: not kubeconfig_file.stat.exists

    - name: Confirm cleanup operation
      pause:
        prompt: |
          
          ‚ö†Ô∏è  WARNING: This will remove the following Weather MCP-Only resources ‚ö†Ô∏è
          
          Resources to be deleted (pure MCP protocol deployment):
          - Job: {{ service_name }}-protocol-test
          - TrafficPolicy: disable-{{ service_name }}-auth
          - HTTPRoute: {{ service_name }}-route
          - Backend: {{ service_name }}-backend
          - Services: {{ service_name }}, {{ service_name }}-external
          - Deployment: {{ service_name }}
          
          Namespace: {{ ai_namespace }}
          Service Type: Pure MCP Protocol (MCP_ONLY=true)
          
          Continue with cleanup? (yes/no)
      register: cleanup_confirmation
      when: not (force_cleanup | default(false) | bool)

    - name: Check cleanup confirmation
      fail:
        msg: "Cleanup operation cancelled by user"
      when: 
        - not (force_cleanup | default(false) | bool)
        - cleanup_confirmation.user_input | lower not in ['yes', 'y']

    # Phase 1: Stop running test job first (if any)
    - name: Remove MCP protocol test job
      kubernetes.core.k8s:
        api_version: batch/v1
        kind: Job
        name: "{{ service_name }}-protocol-test"
        namespace: "{{ ai_namespace }}"
        state: absent
        kubeconfig: "{{ kubeconfig_path }}"
        wait: true
        wait_timeout: 60
      ignore_errors: true

    # Phase 2: Remove TrafficPolicy (must be removed before HTTPRoutes)
    - name: Remove MCP-Only TrafficPolicy
      kubernetes.core.k8s:
        api_version: gateway.kgateway.dev/v1alpha1
        kind: TrafficPolicy
        name: "disable-{{ service_name }}-auth"
        namespace: "{{ ai_namespace }}"
        state: absent
        kubeconfig: "{{ kubeconfig_path }}"
        wait: true
        wait_timeout: 30
      ignore_errors: true

    # Phase 3: Remove HTTPRoute
    - name: Remove MCP-Only HTTPRoute
      kubernetes.core.k8s:
        api_version: gateway.networking.k8s.io/v1
        kind: HTTPRoute
        name: "{{ service_name }}-route"
        namespace: "{{ ai_namespace }}"
        state: absent
        kubeconfig: "{{ kubeconfig_path }}"
        wait: true
        wait_timeout: 30
      ignore_errors: true

    # Phase 4: Remove Backend
    - name: Remove MCP-Only Static Backend
      kubernetes.core.k8s:
        api_version: gateway.kgateway.dev/v1alpha1
        kind: Backend
        name: "{{ service_name }}-backend"
        namespace: "{{ ai_namespace }}"
        state: absent
        kubeconfig: "{{ kubeconfig_path }}"
        wait: true
        wait_timeout: 30
      ignore_errors: true

    # Phase 5: Remove Services (before deployment to avoid endpoint issues)
    - name: Remove MCP-Only Services
      kubernetes.core.k8s:
        api_version: v1
        kind: Service
        name: "{{ item }}"
        namespace: "{{ ai_namespace }}"
        state: absent
        kubeconfig: "{{ kubeconfig_path }}"
        wait: true
        wait_timeout: 60
      loop:
        - "{{ service_name }}"
        - "{{ service_name }}-external"
      ignore_errors: true

    # Phase 6: Remove Deployment
    - name: Remove Weather MCP-Only Deployment
      kubernetes.core.k8s:
        api_version: apps/v1
        kind: Deployment
        name: "{{ service_name }}"
        namespace: "{{ ai_namespace }}"
        state: absent
        kubeconfig: "{{ kubeconfig_path }}"
        wait: true
        wait_timeout: 120
      ignore_errors: true

    # Phase 7: Verify cleanup completion
    - name: Wait for pods to be terminated
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Pod
        namespace: "{{ ai_namespace }}"
        label_selectors:
          - "app={{ service_name }}"
        kubeconfig: "{{ kubeconfig_path }}"
      register: remaining_pods
      until: remaining_pods.resources | length == 0
      retries: 12
      delay: 5
      ignore_errors: true

    # Phase 8: Final verification and cleanup report
    - name: Check for remaining MCP-only resources
      kubernetes.core.k8s_info:
        api_version: "{{ item.api_version }}"
        kind: "{{ item.kind }}"
        namespace: "{{ ai_namespace }}"
        kubeconfig: "{{ kubeconfig_path }}"
      register: remaining_resources
      loop:
        - api_version: apps/v1
          kind: Deployment
        - api_version: v1
          kind: Service
        - api_version: gateway.networking.k8s.io/v1
          kind: HTTPRoute
        - api_version: gateway.kgateway.dev/v1alpha1
          kind: TrafficPolicy
        - api_version: gateway.kgateway.dev/v1alpha1
          kind: Backend
        - api_version: batch/v1
          kind: Job

    - name: Filter MCP-only related resources
      set_fact:
        mcp_only_resources: >-
          {%- set resources = [] -%}
          {%- for result in remaining_resources.results -%}
            {%- for resource in result.resources -%}
              {%- if service_name in resource.metadata.name -%}
                {%- set _ = resources.append({
                  'kind': result.item.kind,
                  'name': resource.metadata.name,
                  'namespace': resource.metadata.namespace
                }) -%}
              {%- endif -%}
            {%- endfor -%}
          {%- endfor -%}
          {{ resources | to_json }}

    # Phase 9: Display cleanup summary
    - name: Display cleanup summary
      debug:
        msg: |
          
          ============ Weather MCP-Only Cleanup Complete ============
          
          {% set parsed_resources = mcp_only_resources | from_json if mcp_only_resources is string else mcp_only_resources %}
          {% if parsed_resources | length == 0 %}
          ‚úÖ CLEANUP SUCCESSFUL - All weather MCP-only resources removed
          {% else %}
          ‚ö†Ô∏è  CLEANUP INCOMPLETE - Remaining resources found
          {% for resource in parsed_resources %}
          - {{ resource.kind }}/{{ resource.name }}
          {% endfor %}
          {% endif %}
          
          Resources Processed:
          ‚úÖ Job: {{ service_name }}-protocol-test
          ‚úÖ TrafficPolicy: disable-{{ service_name }}-auth
          ‚úÖ HTTPRoute: {{ service_name }}-route
          ‚úÖ Backend: {{ service_name }}-backend
          ‚úÖ Services: {{ service_name }}, {{ service_name }}-external
          ‚úÖ Deployment: {{ service_name }}
          
          Service Details:
          üì¶ Service Name: {{ service_name }}
          üéØ Service Type: Pure MCP Protocol (MCP_ONLY=true)
          üåê Namespace: {{ ai_namespace }}
          üîß Cleanup Mode: {{ 'Forced' if (force_cleanup | default(false) | bool) else 'Interactive' }}
          
          {% if parsed_resources | length == 0 %}
          üéâ MCP-only environment is clean and ready for fresh deployment!
          
          Next steps:
          1. Run: ansible-playbook deploy-weather-mcp-only.yml
          2. Or modify MCP configuration and redeploy
          
          MCP Client Testing:
          # Test pure MCP protocol connectivity
          Client('http://localhost:3001')  # Direct root access
          uv run python tools/test_mcp_client.py
          {% else %}
          ‚ö†Ô∏è  Manual cleanup may be required for remaining resources.
          
          Check manually:
          kubectl get all,httproutes,trafficpolicies,backends -n {{ ai_namespace }} | grep {{ service_name }}
          {% endif %}
          
          =======================================================================